
name: Full Stack Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
        - dev
        - staging
        - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --region us-east-1 --name cloudtrade-${{ github.event.inputs.environment }}
    
    - name: Deploy with Kustomize
      run: |
        kubectl apply -k kubernetes/overlays/${{ github.event.inputs.environment }}
    
    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/frontend -n cloudtrade-${{ github.event.inputs.environment }}
        kubectl rollout status deployment/trading-api -n cloudtrade-${{ github.event.inputs.environment }}
        kubectl rollout status deployment/market-data -n cloudtrade-${{ github.event.inputs.environment }}
    
    - name: Run smoke tests
      run: |
        kubectl run smoke-test --rm -i --restart=Never --image=curlimages/curl -- \
          curl -f http://frontend.cloudtrade-${{ github.event.inputs.environment }}.svc.cluster.local || exit 1
